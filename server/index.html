<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ğŸ“¦ Xem dá»¯ liá»‡u JSON Ä‘Ã£ lÆ°u</title>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        background: #f7f7f7;
        padding: 20px;
      }
      h1 {
        color: #333;
      }
      button {
        padding: 8px 12px;
        margin-bottom: 10px;
        cursor: pointer;
        border: none;
        border-radius: 6px;
        background-color: #007bff;
        color: white;
      }
      button:hover {
        background-color: #0056b3;
      }
      ul {
        list-style: none;
        padding: 0;
      }
      li {
        background: white;
        margin: 5px 0;
        padding: 10px;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .filename {
        cursor: pointer;
        color: #007bff;
      }
      pre {
        background: #222;
        color: #0f0;
        padding: 15px;
        border-radius: 8px;
        overflow-x: auto;
        white-space: pre-wrap;
        word-break: break-word;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ“„ Danh sÃ¡ch file JSON Ä‘Ã£ lÆ°u</h1>

    <button id="btn-latest">ğŸ”„ Xem file má»›i nháº¥t</button>

    <ul id="file-list"></ul>

    <h2 id="selected-file-title" style="display:none;">ğŸ“˜ Ná»™i dung file:</h2>
    <pre id="file-content"></pre>

    <script>
      const API_URL = "http://localhost:4000";

      // ğŸŸ¢ Load danh sÃ¡ch file khi má»Ÿ trang
      async function loadFileList() {
        const res = await fetch(`${API_URL}/files`);
        const files = await res.json();

        const list = document.getElementById("file-list");
        list.innerHTML = "";

        if (files.length === 0) {
          list.innerHTML = "<li>ChÆ°a cÃ³ file nÃ o Ä‘Æ°á»£c lÆ°u.</li>";
          return;
        }

        files.forEach((f) => {
          const li = document.createElement("li");
          li.innerHTML = `
            <span class="filename">${f.filename}</span>
            <span>${new Date(f.createdAt).toLocaleString()} - ${f.sizeKB} KB</span>
          `;
          li.querySelector(".filename").onclick = () => viewFile(f.filename);
          list.appendChild(li);
        });
      }

      // ğŸ¨ HÃ m render dá»¯ liá»‡u JSON thÃ nh HTML Ä‘áº¹p
      function renderData(data) {
  if (!data || !data.userResponses) return "<i>KhÃ´ng cÃ³ dá»¯ liá»‡u</i>";

  const u = data.userResponses;

  // âœ… HÃ m tiá»‡n Ã­ch render 1 dÃ²ng icon + tiÃªu Ä‘á» + ná»™i dung
  const row = (icon, label, content) =>
    content
      ? `
      <div style="display:flex;align-items:flex-start;margin:8px 0;">
        <div style="font-size:20px;width:30px;text-align:center;">${icon}</div>
        <div>
          <div style="font-weight:600;color:#333;">${label}</div>
          <div style="color:#444;margin-top:2px;">${content}</div>
        </div>
      </div>`
      : "";

  return `
    <div style="
      background:#fff;
      padding:20px 25px;
      border-radius:14px;
      box-shadow:0 2px 10px rgba(0,0,0,0.08);
      margin-top:10px;
      max-width:600px;
      line-height:1.6;
      font-size:15px;
    ">
      ${row("ğŸ•", "Thá»i gian gá»­i:", new Date(data.timestamp).toLocaleString("vi-VN"))}
      ${row("ğŸš—", "PhÆ°Æ¡ng tiá»‡n:", u.transport || "")}
      ${row("ğŸ“", "Äá»‹a Ä‘iá»ƒm:", u.locations?.map(l => `<span style='background:#f3f3f3;padding:3px 8px;border-radius:6px;margin-right:5px;'>${l}</span>`).join("") || "")}
      ${row("â°", "Thá»i gian háº¹n:", u.dateOptions?.map(d => `<div>${d.date} â€” <b>${d.time}</b></div>`).join("") || "")}
      ${row("ğŸ½ï¸", "MÃ³n Äƒn:", u.foods?.map(f => `<span style='background:#fff4e6;padding:3px 8px;border-radius:6px;margin-right:5px;'>${f}</span>`).join("") || "")}
      ${row("ğŸ¥¤", "Äá»“ uá»‘ng:", u.drinks?.map(d => `<span style='background:#eaf5ff;padding:3px 8px;border-radius:6px;margin-right:5px;'>${d}</span>`).join("") || "")}
      ${row("âŒ", "LÃ½ do tá»« chá»‘i:", u.rejectionReason || "")}
      ${row("ğŸ§ ", "User Agent:", `<code style="font-size:13px;color:#777;">${u.userAgent}</code>`)}
    </div>
  `;
}


      // ğŸ” Xem ná»™i dung 1 file
      async function viewFile(filename) {
        const res = await fetch(`${API_URL}/files/${filename}`);
        const data = await res.json();

        document.getElementById("selected-file-title").style.display = "block";
        document.getElementById("selected-file-title").textContent =
          "ğŸ“˜ Ná»™i dung file: " + filename;

        document.getElementById("file-content").innerHTML = renderData(data);
      }

      // ğŸ†• Xem file má»›i nháº¥t
      async function viewLatest() {
        const res = await fetch(`${API_URL}/latest`);
        if (!res.ok) {
          alert("KhÃ´ng cÃ³ file nÃ o!");
          return;
        }
        const data = await res.json();

        document.getElementById("selected-file-title").style.display = "block";
        document.getElementById("selected-file-title").textContent =
          "ğŸ“˜ File má»›i nháº¥t: " + data.filename;

        document.getElementById("file-content").innerHTML = renderData(data.data);
      }

      document.getElementById("btn-latest").addEventListener("click", viewLatest);
      loadFileList();
    </script>
  </body>
</html>
